<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree with Profile Boxes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: radial-gradient(ellipse at center, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.15),
                0 15px 25px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-size: 2.8em;
            font-weight: 700;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 8px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 4px 15px rgba(102, 126, 234, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow:
                0 8px 25px rgba(102, 126, 234, 0.5),
                0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(-1px);
        }

        .tree-container {
            text-align: center;
            overflow-x: auto;
            padding: 20px;
        }

        .node .profile-box {
            fill: url(#personGradient);
            stroke: #3b82f6;
            stroke-width: 3px;
            rx: 10;
            ry: 10;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.3)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .node.marriage .profile-box {
            fill: url(#marriageGradient);
            stroke: #ef4444;
            stroke-width: 2.5px;
            rx: 10;
            ry: 10;
            filter: drop-shadow(0 4px 8px rgba(239, 68, 68, 0.3)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .node .profile-box:hover {
            fill: url(#personHoverGradient);
            stroke: #1d4ed8;
            stroke-width: 4px;
            transform: scale(1.05);
            filter: drop-shadow(0 8px 16px rgba(59, 130, 246, 0.4)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .node.marriage .profile-box:hover {
            fill: url(#marriageHoverGradient);
            stroke: #dc2626;
            stroke-width: 3.5px;
            transform: scale(1.05);
            filter: drop-shadow(0 8px 16px rgba(239, 68, 68, 0.4)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .node .profile-photo {
            fill: #e5e7eb;
            stroke: #d1d5db;
            stroke-width: 1;
            rx: 5;
            ry: 5;
        }

        .node .photo-placeholder {
            fill: #9ca3af;
            font-size: 24px;
            text-anchor: middle;
            dominant-baseline: central;
        }

        .node .name-text {
            font: 11px sans-serif;
            font-weight: 600;
            text-anchor: middle;
            fill: #333;
            dominant-baseline: central;
        }

        .node.marriage .name-text {
            font-size: 9px;
            fill: #666;
        }

        .node.collapsed .profile-box {
            fill: url(#personCollapsedGradient);
        }

        .node.collapsed.marriage .profile-box {
            fill: url(#marriageCollapsedGradient);
        }

        .link {
            fill: none;
            stroke: url(#linkGradient);
            stroke-width: 2.5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.1));
        }

        .link:hover {
            stroke-width: 4px;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.2));
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 12px 16px;
            font: 13px 'Segoe UI', sans-serif;
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.95));
            color: white;
            border-radius: 12px;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 5px 10px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            padding: 18px;
            border-radius: 15px;
            box-shadow:
                0 10px 25px rgba(0, 0, 0, 0.1),
                0 5px 10px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }

        .legend-symbol {
            width: 30px;
            height: 30px;
            margin-right: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .legend-symbol.marriage {
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Family Tree</h1>

        <div class="controls">
            <button onclick="window.expandAll()">Expand All</button>
            <button onclick="window.collapseAll()">Collapse All</button>
            <button onclick="window.resetView()">Reset View</button>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-symbol"
                    style="background: linear-gradient(145deg, #ffffff 0%, #f0f9ff 100%); border: 3px solid #3b82f6; filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));">
                </div>
                <span>Person</span>
            </div>
            <div class="legend-item">
                <div class="legend-symbol marriage"
                    style="background: linear-gradient(145deg, #fef2f2 0%, #fce7e7 100%); border: 2.5px solid #ef4444; filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));">
                </div>
                <span>Marriage</span>
            </div>
        </div>

        <div class="tree-container">
            <svg id="tree"></svg>
        </div>
    </div>

    <div class="tooltip"></div>

    <script>
        // Original family tree data
        const originalFamilyData = {
            "name": "रघुवर",
            "children": [
                {
                    "name": "रिबई",
                    "children": [
                        {
                            "name": "घमंडी",
                            "note": "इनका नाम कुछ और था पर क्योंकि बचपन में अखाड़ा लड़ने की शक्ति सबसे ज्यादा थी इसलिए इनका नाम घमंडी पड़ गया।\nHe has 3 son, 2 daughter",
                            "children": [
                                {
                                    "name": "सालिक राम",
                                    "note": "He has 3 sons and 1 daughter"
                                },
                                {
                                    "name": "पनमेश्वर दीन",
                                    "note": "He has 3 sons"
                                },
                                {
                                    "name": "राम रतन",
                                    "spouse": "तुलसी देवी",
                                    "note": "They have 4 sons and 1 daughter, names are in order of their birth",
                                    "children": [
                                        { "name": "लीलावती" },
                                        { "name": "राम सुख" },
                                        { "name": "राम कृपाल" },
                                        {
                                            "name": "श्याम लाल",
                                            "spouse": "सिंटू देवी",
                                            "note": "They have a son and a daughter, names are in order of their birth",
                                            "children": [
                                                { "name": "सूरज कुमार" },
                                                { "name": "महिमा" }
                                            ]
                                        },
                                        {
                                            "name": "राम केवल",
                                            "note": "They have 2 daughters, names are in order of their birth",
                                            "children": [
                                                { "name": "सीमा" },
                                                { "name": "रीमा" }
                                            ]
                                        },
                                        {
                                            "name": "रामावती",
                                            "note": "They have 2 son and a daughter, names are in order of their birth",
                                            "children": [
                                                { "name": "राहुल" },
                                                { "name": "कंचन" },
                                                { "name": "लाल" }
                                            ]
                                        }
                                    ]
                                },
                                { "name": "कौशल्या" },
                                { "name": "हौशिल्या" }
                            ]
                        }
                    ]
                }
            ]
        };

        // Function to transform data structure to include marriage nodes
        function transformDataWithMarriages(node) {
            if (node.spouse) {
                // Create the person node first
                const personNode = {
                    name: node.name,
                    note: node.note && !node.note.includes("They have") ? node.note : undefined,
                    children: [
                        {
                            name: `${node.name} ❤️ ${node.spouse}`,
                            type: "marriage",
                            spouse1: node.name,
                            spouse2: node.spouse,
                            note: node.note,
                            children: node.children ? node.children.map(transformDataWithMarriages) : undefined
                        }
                    ]
                };

                return personNode;
            } else {
                // Regular person node, transform children recursively
                return {
                    ...node,
                    children: node.children ? node.children.map(transformDataWithMarriages) : undefined
                };
            }
        }

        // Transform the data
        const familyData = transformDataWithMarriages(originalFamilyData);

        // Additional family members (now empty since orange indicators are removed)
        const additionalFamilyData = {};

        // Set up SVG
        const margin = { top: 40, right: 40, bottom: 40, left: 40 };
        const width = 1200 - margin.left - margin.right;
        const height = 900 - margin.bottom - margin.top;

        const svg = d3.select("#tree")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        // Add gradient definitions
        const defs = svg.append("defs");

        // Link gradient
        const linkGradient = defs.append("linearGradient")
            .attr("id", "linkGradient")
            .attr("gradientUnits", "userSpaceOnUse");

        linkGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#8b5cf6")
            .attr("stop-opacity", 0.8);

        linkGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#06b6d4")
            .attr("stop-opacity", 0.6);

        // Person node gradients
        const personGradient = defs.append("linearGradient")
            .attr("id", "personGradient")
            .attr("x1", "0%").attr("y1", "0%")
            .attr("x2", "100%").attr("y2", "100%");
        personGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#ffffff");
        personGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#f0f9ff");

        const personHoverGradient = defs.append("linearGradient")
            .attr("id", "personHoverGradient")
            .attr("x1", "0%").attr("y1", "0%")
            .attr("x2", "100%").attr("y2", "100%");
        personHoverGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#dbeafe");
        personHoverGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#bfdbfe");

        const personCollapsedGradient = defs.append("linearGradient")
            .attr("id", "personCollapsedGradient")
            .attr("x1", "0%").attr("y1", "0%")
            .attr("x2", "100%").attr("y2", "100%");
        personCollapsedGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#e0e7ff");
        personCollapsedGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#c7d2fe");

        // Marriage node gradients
        const marriageGradient = defs.append("linearGradient")
            .attr("id", "marriageGradient")
            .attr("x1", "0%").attr("y1", "0%")
            .attr("x2", "100%").attr("y2", "100%");
        marriageGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#fef2f2");
        marriageGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#fce7e7");

        const marriageHoverGradient = defs.append("linearGradient")
            .attr("id", "marriageHoverGradient")
            .attr("x1", "0%").attr("y1", "0%")
            .attr("x2", "100%").attr("y2", "100%");
        marriageHoverGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#fecaca");
        marriageHoverGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#fca5a5");

        const marriageCollapsedGradient = defs.append("linearGradient")
            .attr("id", "marriageCollapsedGradient")
            .attr("x1", "0%").attr("y1", "0%")
            .attr("x2", "100%").attr("y2", "100%");
        marriageCollapsedGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#fed7d7");
        marriageCollapsedGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#feb2b2");

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tree = d3.tree().size([width, height]);
        const tooltip = d3.select(".tooltip");

        let root, nodes, links;

        // Function to merge additional family data
        function mergeAdditionalData(node) {
            const nodeName = node.data.name;
            if (additionalFamilyData[nodeName]) {
                const additionalData = additionalFamilyData[nodeName];

                // Count additional children
                const additionalCount = additionalData.children ? additionalData.children.length : 0;

                // Store additional data and count
                node.data.additionalData = additionalData;
                node.data.additionalCount = additionalCount;

                // Initially don't show additional children
                node.data.showingAdditional = false;
            }

            // Recursively check children
            if (node.children) {
                node.children.forEach(child => mergeAdditionalData(child));
            }
            if (node._children) {
                node._children.forEach(child => mergeAdditionalData(child));
            }
        }

        function initializeTree() {
            // Convert data and create hierarchy
            root = d3.hierarchy(familyData, d => d.children);
            root.x0 = width / 2;
            root.y0 = 0;

            // Merge additional data
            mergeAdditionalData(root);

            // Collapse nodes initially (except root)
            root.children?.forEach(collapse);

            update(root);
        }

        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }

        function expand(d) {
            if (d._children) {
                d.children = d._children;
                d.children.forEach(expand);
                d._children = null;
            }
        }

        function update(source) {
            // Assign x and y positions
            const treeData = tree(root);
            nodes = treeData.descendants();
            links = treeData.descendants().slice(1);

            // Normalize for fixed-depth (top to bottom) with more spacing
            nodes.forEach(d => d.y = d.depth * 180);

            // Update nodes
            const node = g.selectAll("g.node")
                .data(nodes, d => d.id || (d.id = ++i));

            // Enter new nodes
            const nodeEnter = node.enter().append("g")
                .attr("class", d => `node ${d.data.type || ''}`)
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on("click", click)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // Add profile boxes for nodes
            nodeEnter.each(function (d) {
                const nodeGroup = d3.select(this);

                // Main profile box
                const boxWidth = d.data.type === "marriage" ? 120 : 80;
                const boxHeight = d.data.type === "marriage" ? 40 : 60;

                nodeGroup.append("rect")
                    .attr("class", "profile-box")
                    .attr("width", boxWidth)
                    .attr("height", boxHeight)
                    .attr("x", -boxWidth / 2)
                    .attr("y", -boxHeight / 2);

                if (d.data.type !== "marriage") {
                    // Photo placeholder area for person nodes
                    nodeGroup.append("rect")
                        .attr("class", "profile-photo")
                        .attr("width", 60)
                        .attr("height", 35)
                        .attr("x", -30)
                        .attr("y", -25);

                    // Photo placeholder icon (person symbol)
                    nodeGroup.append("text")
                        .attr("class", "photo-placeholder")
                        .attr("x", 0)
                        .attr("y", -8)
                        .text("👤");
                }
            });

            // Add name text inside the box (below photo for person nodes, center for marriage nodes)
            nodeEnter.append("text")
                .attr("class", "name-text")
                .attr("x", 0)
                .attr("y", d => d.data.type === "marriage" ? 8 : 15)
                .text(d => d.data.name)
                .each(function (d) {
                    // Word wrap for long names
                    const text = d3.select(this);
                    const words = d.data.name.split(/\s+/);
                    const lineHeight = 1.1; // ems
                    const maxWidth = d.data.type === "marriage" ? 110 : 65;

                    text.text(null);

                    let line = [];
                    let lineNumber = 0;
                    let tspan = text.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "0em");

                    words.forEach(word => {
                        line.push(word);
                        tspan.text(line.join(" "));
                        if (tspan.node().getComputedTextLength() > maxWidth && line.length > 1) {
                            line.pop();
                            tspan.text(line.join(" "));
                            line = [word];
                            tspan = text.append("tspan")
                                .attr("x", 0)
                                .attr("dy", lineHeight + "em")
                                .text(word);
                            lineNumber++;
                        }
                    });
                });

            // Update existing nodes
            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(750)
                .attr("transform", d => `translate(${d.x},${d.y})`);

            // Update profile boxes
            nodeUpdate.selectAll(".profile-box")
                .transition()
                .duration(750)
                .style("fill", d => {
                    if (d.data.type === "marriage") {
                        return d._children ? "url(#marriageCollapsedGradient)" : "url(#marriageGradient)";
                    } else {
                        return d._children ? "url(#personCollapsedGradient)" : "url(#personGradient)";
                    }
                });

            nodeUpdate.selectAll(".name-text")
                .transition()
                .duration(750)
                .style("fill-opacity", 1);

            // Remove exiting nodes
            const nodeExit = node.exit().transition()
                .duration(750)
                .attr("transform", d => `translate(${source.x},${source.y})`)
                .remove();

            nodeExit.selectAll(".profile-box")
                .attr("width", 1e-6)
                .attr("height", 1e-6);

            nodeExit.selectAll(".name-text")
                .style("fill-opacity", 1e-6);

            // Update links
            const link = g.selectAll("path.link")
                .data(links, d => d.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 };
                    return diagonal(o, o);
                });

            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(750)
                .attr("d", d => diagonal(d, d.parent));

            link.exit().transition()
                .duration(750)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y };
                    return diagonal(o, o);
                })
                .remove();

            // Store old positions for transition
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Diagonal path generator for top-to-bottom layout
        function diagonal(s, d) {
            return `M ${s.x} ${s.y}
                    C ${s.x} ${(s.y + d.y) / 2},
                      ${d.x} ${(s.y + d.y) / 2},
                      ${d.x} ${d.y}`;
        }

        // Click handler
        function click(event, d) {
            // Regular expand/collapse behavior
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }

            update(d);
        }

        // Tooltip functions
        function showTooltip(event, d) {
            let tooltipText = d.data.name;
            if (d.data.note) tooltipText += `<br/>${d.data.note}`;
            if (d.data.spouse1 && d.data.spouse2) {
                tooltipText += `<br/>Marriage between: ${d.data.spouse1} & ${d.data.spouse2}`;
            }

            tooltip.transition()
                .duration(200)
                .style("opacity", 0.9);

            tooltip.html(tooltipText)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
        }

        function hideTooltip() {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
        }

        // Control functions
        window.expandAll = function () {
            root.children?.forEach(expand);
            update(root);
        }

        window.collapseAll = function () {
            root.children?.forEach(collapse);
            update(root);
        }

        window.resetView = function () {
            svg.transition().duration(750).call(
                d3.zoom().transform,
                d3.zoomIdentity
            );
        }

        // Add zoom behavior
        svg.call(d3.zoom()
            .extent([[0, 0], [width + margin.left + margin.right, height + margin.top + margin.bottom]])
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            }));

        // Counter for node IDs
        let i = 0;

        // Initialize the tree
        initializeTree();
    </script>
</body>

</html>